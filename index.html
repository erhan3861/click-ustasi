<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click UstalÄ±ÄŸÄ±</title>
  <style>
    :root{
      --primary:#6c5dd3; --accent:#ffde59; --bg1:#0f1020; --bg2:#1a1b34;
      --text:#f5f7fb; --muted:#b9bcd6; --glass:rgba(255,255,255,0.06);
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:20px; --radius-sm:12px;
      --trans-fast:.15s ease; --trans:.3s ease; --danger:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, #251f5a 0%, #141433 35%, #0c0d1f 70%),
                  radial-gradient(1200px 800px at 90% 90%, #2a225f 0%, #161738 40%, #0f1020 75%);
      background-attachment: fixed;
    }
    @media (prefers-reduced-motion: no-preference){
      body{animation:bgfloat 18s ease-in-out infinite alternate}
      @keyframes bgfloat{from{background-position:0 0,0 0} to{background-position:30px 20px,-30px -20px}}
    }

    .container{min-height:100%; display:grid; grid-template-rows:auto 1fr auto; gap:20px; padding:20px; max-width:1200px; margin:0 auto;}
    header, footer{
      background:linear-gradient(135deg, rgba(108,93,211,.25), rgba(255,222,89,.12));
      backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow); border-radius:var(--radius); padding:14px 18px;
    }
    header{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .brand{display:flex; align-items:center; gap:14px}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg,var(--primary),#8c82ff);
      box-shadow:0 8px 24px rgba(108,93,211,.35); display:grid; place-items:center; font-weight:700}
    .logo span{font-size:22px}
    .titles h1{font-size:20px; margin:0}
    .titles small{color:var(--muted)}
    .hud{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .pill{background:var(--glass); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:8px 12px; display:flex; align-items:center; gap:8px}
    .pill strong{font-weight:700}
    .btn-icon{appearance:none; border:1px solid rgba(255,255,255,.12); background:var(--glass); color:var(--text); border-radius:12px; width:42px; height:42px; display:grid; place-items:center; cursor:pointer; transition:transform var(--trans-fast), background var(--trans-fast)}
    .btn-icon:hover{transform:translateY(-1px)}
    .btn-icon:active{transform:translateY(1px) scale(.98)}

    #iconExpand{position:relative; top:-10px; left:-16px; width:60px; height:60px; display:block; object-fit:contain}

    main{display:grid; grid-template-columns: 1.2fr .8fr; gap:20px}
    @media (max-width: 900px){ main{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;}

    .stage{display:grid; place-items:center; gap:16px; text-align:center}
    .score{font-size:148px; font-weight:800; letter-spacing:.5px; margin:0 0 8px 0; text-shadow:0 6px 18px rgba(0,0,0,.55);}
    .subtitle{color:var(--muted); margin:0 0 16px 0}
    .click-btn{appearance:none; border:none; cursor:pointer; color:#13132a; font-weight:800; letter-spacing:.3px;
      background:linear-gradient(180deg,#ffde59,#ffd22a); border-radius:30px; padding:26px 40px; font-size:30px;
      box-shadow: 0 14px 36px rgba(255,222,89,.35), inset 0 -6px 0 rgba(0,0,0,.12);
      transition: transform var(--trans-fast), filter var(--trans-fast);}
    .click-btn:hover{transform: translateY(-2px)}
    .click-btn:active{transform: translateY(1px) scale(.98)}
    .click-btn[disabled]{filter:grayscale(.3) brightness(.7); cursor:not-allowed}

    .flying{position:fixed; pointer-events:none; font-weight:700; color:#9be7ff; text-shadow:0 4px 10px rgba(0,0,0,.5)}

    .panel{display:grid; gap:16px}
    .progress{display:grid; gap:8px}
    .progress .bar{height:18px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
    .progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--primary), #8c82ff); transition:width var(--trans);}
    .progress small{color:var(--muted)}

    .ach-grid{display:grid; grid-template-columns: repeat(4, minmax(60px,1fr)); gap:10px}
    @media (max-width:520px){.ach-grid{grid-template-columns: repeat(3, minmax(60px,1fr));}}
    .ach{background:var(--glass); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius-sm); padding:10px; text-align:center; min-height:74px;}
    .ach.locked{opacity:.45; filter:grayscale(.6)}
    .ach .big{font-size:22px}
    .ach small{display:block; color:var(--muted); margin-top:4px}

    footer{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .microcopy{color:var(--muted)}

    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:20px; z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{position:relative; width:min(720px, 100%); background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.18); border-radius:var(--radius); box-shadow:var(--shadow); padding:26px;}
    .modal h3{margin:0 0 10px 0; font-size:1.3rem}
    .modal p{margin:0 0 12px 0; color:#e9ecff}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.16); background:var(--glass); color:var(--text);
      border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; transition:transform var(--trans-fast), background var(--trans-fast)}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(1px) scale(.98)}
    .btn.primary{background:linear-gradient(180deg,var(--primary),#5a4acc)}
    .btn.warn{background:linear-gradient(180deg,#c94040,#a22d2d)}
    .codebox{display:flex; align-items:center; justify-content:space-between; gap:8px; background:rgba(0,0,0,.25); border:1px dashed rgba(255,255,255,.35); border-radius:16px; padding:16px 18px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .codebox code{font-weight:900; letter-spacing:1px; font-size:2rem; color:#fff; text-shadow:0 0 8px rgba(255,222,89,.95), 0 0 22px rgba(108,93,211,.75)}
    .btn-close{position:absolute; top:10px; left:10px; width:38px; height:38px; border-radius:10px; display:grid; place-items:center; font-size:20px; line-height:1; cursor:pointer; border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.25); color:#fff; transition:transform var(--trans-fast), background var(--trans-fast)}
    .btn-close:hover{transform:translateY(-1px)}
    .btn-close:active{transform:translateY(1px) scale(.98)}
    .btn-close.red{background:linear-gradient(180deg, #ff6b6b, #e74c3c); border-color:rgba(0,0,0,.2); box-shadow:0 8px 20px rgba(231,76,60,.35)}
    #modalRank .btn-close.red{top:10px; right:10px; left:auto}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <div class="container">
    <header aria-label="Ãœst Ã§ubuk">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>âš¡</span></div>
        <div class="titles">
          <h1>Click UstalÄ±ÄŸÄ±</h1>
          <small>Ä°lkokul & Ortaokul iÃ§in eÄŸlenceli tÄ±k oyunu</small>
        </div>
      </div>
      <div class="hud" role="group" aria-label="Durum">
        <div class="pill" aria-live="polite" aria-atomic="true"><span>ğŸ¯</span><span><strong>Puan:</strong> <span id="scoreTop">0</span></span></div>
        <div class="pill" aria-live="polite" aria-atomic="true"><span id="rankBadge">ğŸ“</span><span><strong>Unvan:</strong> <span id="rankName">Click Ã–ÄŸrencisi</span></span></div>
        <button id="btnFullscreen" class="btn-icon" aria-label="Tam Ekran" title="Tam Ekran Modu">
          <img id="iconExpand" src="https://raw.githubusercontent.com/erhan3861/Maze-oyunu/main/maximize.png" alt="Tam Ekran Yap">
          <img id="iconCompress" src="https://raw.githubusercontent.com/erhan3861/Maze-oyunu/main/minimize.png" alt="Tam Ekrandan Ã‡Ä±k" style="width:20px; height:20px; display:none;">
        </button>
        <button id="btnSettings" class="btn-icon" aria-label="Ayarlar" title="Ayarlar">âš™ï¸</button>
      </div>
    </header>

    <main>
      <section class="card stage" aria-labelledby="stageTitle">
        <h2 id="stageTitle" class="sr-only">Oyun Sahnesi</h2>
        <p class="score" id="score">0</p>
        <p class="subtitle" id="subtitle">TÄ±kla ve yÃ¼ksel!</p>
        <button id="btnClick" class="click-btn" aria-label="Puan kazan">TÄ±kla!</button>
        <canvas id="confetti" width="0" height="0" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;"></canvas>
        <audio id="clickSound" preload="auto">
          <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
        </audio>
      </section>

      <aside class="panel">
        <section class="card" aria-labelledby="progressTitle">
          <h3 id="progressTitle">Seviye & Ä°lerleme</h3>
          <div class="progress">
            <div class="bar" aria-label="Ä°lerleme Ã§ubuÄŸu"><span id="barFill" style="width:0%"></span></div>
            <small><span id="progressText">Sonraki Unvana Kalan: 50</span></small>
          </div>
        </section>
        
        <section class="card" aria-labelledby="achTitle">
          <h3 id="achTitle">BaÅŸarÄ± Rozetleri</h3>
          <div class="ach-grid" id="achGrid"></div>
        </section>
      </aside>
    </main>

    <footer>
      <div class="microcopy" id="tips">Ritmi yakala, tÄ±klar seni yÃ¼kseltsin!</div>
      <small>Â© 2025 Click UstalÄ±ÄŸÄ± â€¢ <a href="#" style="color:var(--accent); text-decoration:none">EÄŸitici oyun</a></small>
    </footer>
  </div>

  <!-- Kod Modal -->
  <div class="modal-backdrop" id="modalCode" role="dialog" aria-modal="true" aria-labelledby="codeTitle" aria-hidden="true">
    <div class="modal">
      <button class="btn-close red" aria-label="Kapat" data-close="modalCode">âœ•</button>
      <h3 id="codeTitle">IsÄ±nma Bitti</h3>
      <p>Tebrikler! Ä°lk eÅŸiÄŸi geÃ§tin.</p>
      <div class="actions"><button class="btn primary" id="btnCloseCode" data-close="modalCode" disabled>3 sn...</button></div>
    </div>
  </div>

  <!-- Rank Modal -->
  <div class="modal-backdrop" id="modalRank" role="dialog" aria-modal="true" aria-labelledby="rankCodeTitle" aria-hidden="true">
    <div class="modal">
      <button class="btn-close red" aria-label="Kapat" data-close="modalRank">âœ•</button>
      <h3 id="rankCodeTitle">Seviye Åifresi</h3>
      <p id="rankCodeDesc">Yeni unvanÄ±na ulaÅŸtÄ±n! AÅŸaÄŸÄ±daki ÅŸifreyi gÃ¼venle sakla.</p>
      <div class="codebox">
        <code id="rankSecretCode">T14-CEFS-2025-TR-9X7A-2QPM-VALOR-7H</code>
        <button class="btn" id="btnCopyRank">ğŸ“‹ Kopyala</button>
      </div>
      <div class="actions" id="rankActions">
        <button class="btn primary" id="btnCloseRank" data-close="modalRank">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Ayarlar Modal -->
  <div class="modal-backdrop" id="modalSettings" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" aria-hidden="true">
    <div class="modal">
      <h3 id="settingsTitle">Ayarlar</h3>
      <p>Tercihlerini dÃ¼zenle.</p>
      <div style="display:grid; gap:10px; margin:12px 0">
        <label class="pill" style="justify-content:space-between">
          <span>ğŸ”Š Ses</span>
          <input type="checkbox" id="optSound" />
        </label>
        <label class="pill" style="justify-content:space-between">
          <span>ğŸ‰ Konfeti</span>
          <input type="checkbox" id="optConfetti" checked />
        </label>
        <button class="btn warn" id="btnReset">Veriyi SÄ±fÄ±rla</button>
      </div>
      <div class="actions"><button class="btn primary" data-close="modalSettings">Kapat</button></div>
    </div>
  </div>

  <div class="sr-only" aria-live="polite" id="live"></div>

  <script>
    // ====== Durum & LS
    const LS_KEYS = { total:'click_total', ach:'unlocked_achievements', settings:'settings', shown:'shown_codes' };
    // ÅAMPÄ°YON kaldÄ±rÄ±ldÄ±; oyun 200'de biter
    const RANKS = [
      { name:'Click Ã–ÄŸrencisi', min:0,   max:49,  badge:'ğŸ“' },
      { name:'Click UstasÄ±',   min:50,  max:199, badge:'ğŸ› ï¸' },
      { name:'Click Efsanesi', min:200, max:Infinity, badge:'ğŸ†' }
    ];
    const ACH_DEFS = [
      { key:'a10',  at:10,  label:'IsÄ±nma Bitti',      emoji:'ğŸ”¥' },
      { key:'a50',  at:50,  label:'Ritmi YakaladÄ±n',   emoji:'ğŸ¶' },
      { key:'a100', at:100, label:'YÃ¼zlÃ¼k Oldu!',      emoji:'ğŸ’¯' },
      { key:'a200', at:200, label:'Efsane BaÅŸlangÄ±cÄ±', emoji:'ğŸŒŸ' }
    ];
    const RANK_CODES = { 'Click Efsanesi': 'T14-CEFS-2025-TR-9X7A-2QPM-VALOR-7H' }; // Åampiyon kodu kaldÄ±rÄ±ldÄ±
    const MICROCOPY = [
      'Ritmi yakala, tÄ±klar seni yÃ¼kseltsin!',
      'KÄ±sa molalar ver, hÄ±zÄ±nÄ± koru.',
      'Unvana az kaldÄ±, devam!',
      'Hedef belirle: 50 â†’ UstalÄ±k!',
      'KÃ¼Ã§Ã¼k adÄ±mlar bÃ¼yÃ¼k sonuÃ§lar getirir.'
    ];
    const state = {
      total:0, achievements:new Set(), settings:{ sound:false, confetti:true },
      shownCodes:new Set(), motionOK: !window.matchMedia('(prefers-reduced-motion: reduce)').matches,
      paused:false, gameOver:false
    };
    const RESET_ON_RELOAD = true;

    function isPageReload(){ const nav = performance.getEntriesByType?.('navigation')?.[0]; return nav ? nav.type === 'reload' : performance?.navigation?.type === 1; }
    function clearStorage(){ Object.values(LS_KEYS).forEach(k => localStorage.removeItem(k)); }
    function resetUIToFresh(){
      state.total = 0; state.achievements = new Set(); state.settings = { sound:false, confetti:true }; state.shownCodes = new Set();
      updateScoreUI(); updateRank(); renderAchievements(); applySettingsToUI(); live('Veriler sÄ±fÄ±rlandÄ±.');
    }
    function hardReset(){ clearStorage(); resetUIToFresh(); }

    const els = {
      scoreTop: q('#scoreTop'), score: q('#score'), subtitle: q('#subtitle'), btnClick: q('#btnClick'), btnSettings: q('#btnSettings'),
      barFill: q('#barFill'), progressText: q('#progressText'), rankBadge: q('#rankBadge'), rankName: q('#rankName'),
      achGrid: q('#achGrid'), tips: q('#tips'), live: q('#live'), modalCode: q('#modalCode'), modalSettings: q('#modalSettings'),
      btnCopy: q('#btnCopy'), btnReset: q('#btnReset'), optSound: q('#optSound'), optConfetti: q('#optConfetti'), clickSound: q('#clickSound'),
      confetti: q('#confetti'), btnCloseCode: q('#btnCloseCode'), modalRank: q('#modalRank'), btnCloseRank: q('#btnCloseRank'), rankActions: q('#rankActions'),
      btnFullscreen: q('#btnFullscreen'), iconExpand:q('#iconExpand'), iconCompress:q('#iconCompress')
    };
    function q(s){return document.querySelector(s)}

    function loadState(){
      const t = Number(localStorage.getItem(LS_KEYS.total) || '0'); state.total = isNaN(t)?0:t;
      try{ state.achievements = new Set(JSON.parse(localStorage.getItem(LS_KEYS.ach) || '[]')); }catch{}
      try{ const s = JSON.parse(localStorage.getItem(LS_KEYS.settings) || '{}'); state.settings = { sound:!!s.sound, confetti: s.confetti !== undefined ? !!s.confetti : true }; }catch{}
      try{ state.shownCodes = new Set(JSON.parse(localStorage.getItem(LS_KEYS.shown) || '[]')); }catch{}
    }
    function saveState(){
      localStorage.setItem(LS_KEYS.total, String(state.total));
      localStorage.setItem(LS_KEYS.ach, JSON.stringify([...state.achievements]));
      localStorage.setItem(LS_KEYS.settings, JSON.stringify(state.settings));
      localStorage.setItem(LS_KEYS.shown, JSON.stringify([...state.shownCodes]));
    }

    function currentRank(total){ return RANKS.find(r => total >= r.min && total <= r.max); }
    function nextRankTarget(total){ const next = RANKS.find(r => total < r.min); return next ? next.min : null; }
    function setText(node, text){ node.textContent = String(text); }
    function vibrate(ms=20){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} }
    function live(msg){ setText(els.live, msg); }
    function setPaused(p){ state.paused = p; els.btnClick.toggleAttribute('disabled', p || state.gameOver); }

    async function copyToClipboard(text){
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
        else { const ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.top='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        live('Åifre kopyalandÄ±.');
      }catch(e){ console.warn(e); live('Kopyalama baÅŸarÄ±sÄ±z.'); }
    }

    function flyingText(x,y,text='+1'){
      if(!state.motionOK || state.paused || state.gameOver) return;
      const el = document.createElement('div'); el.className='flying'; el.textContent=text; el.style.left=x+'px'; el.style.top=y+'px'; el.style.opacity='1'; el.style.transition='transform .7s ease, opacity .7s ease';
      document.body.appendChild(el); requestAnimationFrame(()=>{ el.style.transform='translateY(-40px)'; el.style.opacity='0'; }); setTimeout(()=> el.remove(),800);
    }

    const confetti = {
      ctx:null, parts:[],
      spawn(n=120){
        if(!state.settings.confetti || !state.motionOK) return;
        const {width:w, height:h} = els.confetti.getBoundingClientRect();
        this.parts.length=0;
        for(let i=0;i<n;i++){ this.parts.push({ x:Math.random()*w, y:-10-Math.random()*h*0.3, s:4+Math.random()*6, vx:-1+Math.random()*2, vy:1+Math.random()*3, rot:Math.random()*Math.PI, vr:(-0.1+Math.random()*0.2) }); }
      },
      loop(){
        const c=els.confetti, ctx=this.ctx; if(!ctx) return;
        const w=c.width=c.clientWidth, h=c.height=c.clientHeight; ctx.clearRect(0,0,w,h); ctx.save();
        for(const p of this.parts){ p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; if(p.y>h+20){ p.y=-10; p.x=Math.random()*w; }
          ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=Math.random()>.5?'#ffde59':'#8c82ff'; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.setTransform(1,0,0,1,0,0); }
        ctx.restore(); requestAnimationFrame(()=>this.loop());
      }
    };

    function toggleFullscreen(){
      if(!document.fullscreenElement){ document.documentElement.requestFullscreen().catch(err=>alert(`Tam ekran aÃ§Ä±lamadÄ±: ${err.message}`)); }
      else if(document.exitFullscreen){ document.exitFullscreen(); }
    }
    function updateFullscreenIcon(){ if(document.fullscreenElement){ els.iconExpand.style.display='none'; els.iconCompress.style.display='block'; } else { els.iconExpand.style.display='block'; els.iconCompress.style.display='none'; } }

    function renderAchievements(){
      els.achGrid.innerHTML=''; for(const a of ACH_DEFS){ const unlocked=state.achievements.has(a.key);
        const div=document.createElement('div'); div.className='ach'+(unlocked?'':' locked'); div.innerHTML=`<div class="big">${a.emoji}</div><small>${a.label}</small>`; els.achGrid.appendChild(div); }
    }
    function unlockAchievement(key){
      const def=ACH_DEFS.find(a=>a.key===key); if(!def) return;
      if(!state.achievements.has(key)){ state.achievements.add(key); saveState(); renderAchievements(); if(state.settings.confetti) confetti.spawn(80); vibrate(15); live(`BaÅŸarÄ± aÃ§Ä±ldÄ±: ${def.label}`); }
    }
    function updateRank(){
      const r=currentRank(state.total); setText(els.rankName, r.name); setText(els.rankBadge, r.badge);
      const next=nextRankTarget(state.total);
      if(next===null){ setText(els.progressText, 'En yÃ¼ksek unvandasÄ±n!'); els.barFill.style.width='100%'; }
      else{ const curMin=r.min, span=next-curMin, done=state.total-curMin, pct=Math.max(0,Math.min(100,Math.round(done/span*100))); els.barFill.style.width=pct+'%'; setText(els.progressText, `Sonraki Unvana Kalan: ${Math.max(0,next-state.total)}`); }
    }
    function updateScoreUI(){ setText(els.score, state.total); setText(els.scoreTop, state.total); }

    function onClick(e){
      if(state.paused || state.gameOver) return;
      state.total += 1;
      if(state.settings.sound){ try{ els.clickSound.currentTime=0; els.clickSound.play(); }catch{} }
      const x=(e.clientX || innerWidth/2), y=(e.clientY || innerHeight/2);
      flyingText(x,y,'+1'); vibrate(12);
      if(state.total===10) showTimedCodeModal();
      for(const a of ACH_DEFS){ if(state.total===a.at) unlockAchievement(a.key); }
      const prev=currentRank(state.total-1), now=currentRank(state.total);
      if(prev.name!==now.name){
        if(state.settings.confetti) confetti.spawn(150);
        vibrate(25); live(`Yeni Unvan: ${now.name}`); showRankModal(now.name);
      }
      // 200 PUAN = OYUN TAMAMLANDI
      if(state.total>=200 && !state.gameOver && now.name==='Click Efsanesi'){
        state.gameOver = true;
      }
      updateScoreUI(); updateRank(); saveState();
    }

    function showModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.add('show'); el.setAttribute('aria-hidden','false'); setPaused(true); }
    function closeModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.remove('show'); el.setAttribute('aria-hidden','true'); if(!state.gameOver) setPaused(false); }
    function showTimedCodeModal(){
      showModal('modalCode'); let t=3; const btn=els.btnCloseCode; btn.disabled=true; btn.textContent=`${t} sn...`;
      const iv=setInterval(()=>{ t--; btn.textContent = t>0?`${t} sn...`:'Kapat'; if(t<=0){ clearInterval(iv); btn.disabled=false; } },1000);
    }
    function showRankModal(rankName){
      const code=RANK_CODES[rankName]; if(!code) return;
      q('#rankSecretCode').textContent = code;
      q('#rankCodeDesc').textContent = `${rankName} oldun! Bu Ã¶zel ÅŸifreyi sakla.`;
      showModal('modalRank');
      if(!state.shownCodes.has(rankName)){ state.shownCodes.add(rankName); saveState(); }
      if(state.settings.confetti) confetti.spawn(180); vibrate(30); live(`Seviye ÅŸifresi gÃ¶sterildi: ${rankName}`);
      if(rankName==='Click Efsanesi'){ state.gameOver = true; }
    }
    function applySettingsToUI(){ els.optSound.checked=!!state.settings.sound; els.optConfetti.checked=!!state.settings.confetti; els.btnClick.toggleAttribute('disabled', state.paused || state.gameOver); }
    function rotateTip(){ const tip=MICROCOPY[Math.floor(Math.random()*MICROCOPY.length)]; els.tips.textContent=tip; }

    function init(){
      loadState();
      if(RESET_ON_RELOAD && isPageReload()) hardReset();

      updateScoreUI(); updateRank(); renderAchievements(); applySettingsToUI();
      rotateTip(); setInterval(rotateTip,6000);

      confetti.ctx = els.confetti.getContext('2d'); confetti.loop();

      els.btnClick.addEventListener('click', onClick);
      els.btnClick.addEventListener('keydown', ev=>{ if(ev.key===' '||ev.key==='Enter'){ ev.preventDefault(); onClick(ev); }});
      els.btnSettings && els.btnSettings.addEventListener('click', ()=>showModal('modalSettings'));
      document.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', ()=>closeModal(btn.getAttribute('data-close'))));
      [els.modalCode, els.modalSettings].filter(Boolean).forEach(m=>m.addEventListener('click', e=>{ if(e.target===m) closeModal(m.id); }));
      if(els.btnCloseCode) els.btnCloseCode.disabled = true;

      const ro=new ResizeObserver(()=>{ const c=els.confetti; c.width=c.clientWidth; c.height=c.clientHeight; }); ro.observe(document.body);

      els.btnFullscreen.addEventListener('click', toggleFullscreen);
      document.addEventListener('fullscreenchange', updateFullscreenIcon);
      updateFullscreenIcon();

      if(els.btnReset){ els.btnReset.addEventListener('click', ()=>{ if(confirm('TÃ¼m verileri sÄ±fÄ±rlamak istiyor musun?')){ hardReset(); closeModal('modalSettings'); } }); }
      els.optSound.addEventListener('change', ()=>{ state.settings.sound=!!els.optSound.checked; saveState(); });
      els.optConfetti.addEventListener('change', ()=>{ state.settings.confetti=!!els.optConfetti.checked; saveState(); });

      document.addEventListener('click', async(e)=>{ if(e.target && e.target.id==='btnCopyRank'){ await copyToClipboard(q('#rankSecretCode').textContent); } });
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
